<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="This vignette presents the main features of the httpcache package, showing how to use the cache-aware HTTP functions, how to invalidate cache as needed, and how to use logging to assess the performance of the cache.">
<title>Improving API client performance with httpcache • httpcache</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Improving API client performance with httpcache">
<meta property="og:description" content="This vignette presents the main features of the httpcache package, showing how to use the cache-aware HTTP functions, how to invalidate cache as needed, and how to use logging to assess the performance of the cache.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-default navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">httpcache</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/httpcache.html">Get Started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nealrichardson/httpcache">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://enpiar.com">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Improving API client performance with httpcache</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nealrichardson/httpcache/blob/HEAD/vignettes/httpcache.Rmd" class="external-link"><code>vignettes/httpcache.Rmd</code></a></small>
      <div class="d-none name"><code>httpcache.Rmd</code></div>
    </div>

    
    
<p><code>httpcache</code> provides the HTTP verb functions
<code><a href="../reference/cached-http-verbs.html">GET()</a></code>, <code><a href="../reference/cached-http-verbs.html">PUT()</a></code>, <code><a href="../reference/cached-http-verbs.html">PATCH()</a></code>,
<code><a href="../reference/cached-http-verbs.html">POST()</a></code>, and <code><a href="../reference/cached-http-verbs.html">DELETE()</a></code>, which are drop-in
replacements for those in the <a href="https://httr.r-lib.org" class="external-link">httr</a>
package. <code><a href="../reference/cached-http-verbs.html">GET()</a></code> responses are added to the local query
cache; <code><a href="../reference/cached-http-verbs.html">PUT()</a></code>, <code><a href="../reference/cached-http-verbs.html">PATCH()</a></code>, <code><a href="../reference/cached-http-verbs.html">POST()</a></code>,
and <code><a href="../reference/cached-http-verbs.html">DELETE()</a></code> requests trigger cache invalidation on the
associated resources. For APIs where a <code>POST</code> requests is
used to send a command that returns content and doesn’t modify state
(and hence is semantically more of a <code>GET</code>), you can use
<code><a href="../reference/cachedPOST.html">cachedPOST()</a></code>, which writes to the cache and doesn’t
invalidate.</p>
<p>To take advantage of these cache-aware functions, all you need to do
is load <code>httpcache</code> instead of <code>httr</code>, or in
package development, import from <code>httpcache</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://enpiar.com/r/httpcache/">httpcache</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cached-http-verbs.html">GET</a></span><span class="op">(</span><span class="st">"https://httpbin.org/get"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.031   0.014   3.993</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cached-http-verbs.html">GET</a></span><span class="op">(</span><span class="st">"https://httpbin.org/get"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##       0       0       0</span></span></code></pre>
<p>Notice how the second request returns instantly. It’s reading from
cache—there’s no communication with a remote server, so no network
latency and no server processing time. Remember: the fastest API request
is the one you don’t have to make.</p>
<p>Reading from the query cache yields exactly the same response as if
we had contacted the server. We can confirm:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="section level2">
<h2 id="query-logging">Query logging<a class="anchor" aria-label="anchor" href="#query-logging"></a>
</h2>
<p>How do we know, other than by the faster response, that we’re hitting
cache and not making server requests?</p>
<p>When designing API clients in R, logging is an invaluable tool for
understanding and improving request patterns. As you build layers of
abstraction on top of the direct HTTP requests, it can be easy to make
inefficient or repetitive requests that degrade performance for your
users and impose unnecessary load on your servers. You can’t improve
what you can’t measure, and the logging tools included in
<code>httpcache</code> can help you measure.</p>
<p>Let’s clear the cache and repeat that exercise, this time with
logging enabled. Use <code><a href="../reference/startLog.html">startLog()</a></code> to enable the request log.
<code>startLog</code> takes a file or connection argument, which it
passes to <code>cat</code> for log writing. The default, same as for
<code>cat</code>, prints to the standard output—your display, in an
interactive session. (See <code><a href="https://rdrr.io/r/base/cat.html" class="external-link">?cat</a></code> for details.)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cache-management.html">clearCache</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/startLog.html">startLog</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cached-http-verbs.html">GET</a></span><span class="op">(</span><span class="st">"http://httpbin.org/get"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 2023-04-07T09:49:42.647 HTTP GET http://httpbin.org/get 200 368 0 0.001 0.158 0.158 1.953 1.953</span></span>
<span><span class="co">## 2023-04-07T09:49:42.648 CACHE SET http://httpbin.org/get</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cached-http-verbs.html">GET</a></span><span class="op">(</span><span class="st">"http://httpbin.org/get"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 2023-04-07T09:49:42.649 CACHE HIT http://httpbin.org/get</span></span></code></pre>
<p>Notice how the first request results in an “HTTP GET” and a “CACHE
SET”, while the second one gets a “CACHE HIT” and does not touch “HTTP”.
From this log output, we can conclude that the query cache is
working.</p>
<div class="section level3">
<h3 id="log-analysis">Log analysis<a class="anchor" aria-label="anchor" href="#log-analysis"></a>
</h3>
<p>You can also pass a file name to <code>startLog</code>. This makes it
easier to read the log output back in as a <code>data.frame</code> and
analyze it quantitatively.
<!-- We'll do an example of that below. --></p>
</div>
<div class="section level3">
<h3 id="custom-logging">Custom logging<a class="anchor" aria-label="anchor" href="#custom-logging"></a>
</h3>
<p>You may want to send other events to the log, interspersed with your
HTTP requests, whether for their own sake or to see how work done in R
outside of the HTTP layer maps onto your server traffic. The function
<code><a href="../reference/logMessage.html">logMessage()</a></code> writes to the connection specified by
<code>startLog</code>, and it is available for general use. For error
logging, the <code><a href="../reference/halt.html">halt()</a></code> function wraps <code>stop</code> and
sends a message to the log (it also makes the awkwardly named
<code>call.</code> argument to <code>stop</code> default to
<code>FALSE</code> for cleaner error messaging).</p>
</div>
</div>
<div class="section level2">
<h2 id="cache-invalidation">Cache invalidation<a class="anchor" aria-label="anchor" href="#cache-invalidation"></a>
</h2>
<p>As the <a href="https://martinfowler.com/bliki/TwoHardThings.html" class="external-link">saying (or
joke, depending on the version)</a>, cache invalidation is one of the
two hard problems in computer science. The trouble with caching what the
server serves is that the server is the source of truth, and if the
state of data on the server changes, our local copy of the data is
stale. In some applications and with some APIs, we have no idea when the
server state changes, but in many cases, the source of change on the
server is actions that we initiate ourselves. In these cases, a local
query cache is more feasible, and cache invalidation more tractable.</p>
<p><code>httpcache</code> provides some functions to direct cache
invalidation. We’ve seen one already, <code><a href="../reference/cache-management.html">clearCache()</a></code>, which
wipes the entire cache. Other functions give more surgical control.
<code><a href="../reference/dropCache.html">dropOnly()</a></code> invalidates cache only for the specified URL.
<code><a href="../reference/dropCache.html">dropPattern()</a></code> uses regular expression matching to
invalidate cache. <code><a href="../reference/dropCache.html">dropCache()</a></code> is a convenience wrapper
around <code>dropPattern</code> that invalidates cache for any resources
that start with the given URL.</p>
<p>Depending on the API with which you’re communicating, you may not
need to use those cache-invalidation functions directly, or you may need
them only infrequently. <code>httpcache</code> was designed with <a href="https://en.wikipedia.org/wiki/Representational_state_transfer" class="external-link">RESTful</a>
APIs in mind, particularly those that expose resources that contain
collections of entities that can be created, replaced, updated, and
deleted (“<a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" class="external-link">CRUD</a>”)
with POST, PUT, PATCH, and DELETE, respectively. Consequently, these
four HTTP verb functions are built with default cache invalidation
actions: <code>POST</code> invalidates cache only for the request URL
(<code>dropOnly</code>), for the case where POST creates a new entity
appearing as a subresource; while <code>PUT</code>, <code>PATCH</code>,
and <code>DELETE</code> drop cache for the request URL and everything
“below” it (<code>dropCache</code>).</p>
<p>For example, if <code>GET http://api.example/projects/</code> returns
a catalog of project entities, and POST to
<code>http://api.example/projects/</code> creates a resource at
<code>http://api.example/projects/new_id/</code>, we need to bust cache
for the project catalog on POST, but our cached responses for resources
such as <code>http://api.example/projects/old_id/</code> should still be
valid. But, if we modify
<code>http://api.example/projects/new_id/</code>, we should invalidate
cache for that resource and for other resources appearing as
subresources of it, such as
<code>http://api.example/projects/new_id/users/</code>.</p>
<p>These verb functions in <code>httpcache</code> (<code><a href="../reference/cached-http-verbs.html">POST()</a></code>,
<code><a href="../reference/cached-http-verbs.html">PUT()</a></code>, <code><a href="../reference/cached-http-verbs.html">PATCH()</a></code>, and <code><a href="../reference/cached-http-verbs.html">DELETE()</a></code>) all
take a <code>drop</code> argument, which defaults as described above. To
override them, you can specify a different call other than
<code>dropCache(url)</code> or <code>dropOnly(url)</code>, or you can
pass <code>drop = NULL</code> and call the cache-invalidation functions
directly outside of the request functions. Depending on your API and
your usage of it, however, <code>httpcache</code>’s cache management may
just work for you with no additional effort.</p>
</div>
<div class="section level2">
<h2 id="caching-across-sessions">Caching across sessions<a class="anchor" aria-label="anchor" href="#caching-across-sessions"></a>
</h2>
<p>The query cache you build up in one R session doesn’t have to end
with it. Use <code><a href="../reference/saveCache.html">saveCache()</a></code> to write out the contents of your
cache to a <code>.rds</code> file. Restore it later with
<code><a href="../reference/saveCache.html">loadCache()</a></code>.</p>
<!--
## Example

For a more complete example of the caching, logging, and invalidation features, we'll use a mock HTTP interface from the `httptest` package, which allows demonstration of the features of `httpcache` without requiring a network connection.  We'll make a series of requests, both reads and writes, and we'll capture the action with the logging tools.


```r
library(httptest)
```

```
## Loading required package: testthat
```

do requests. look at log. show cache invalidation. then show reading without internet -->
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Neal Richardson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
