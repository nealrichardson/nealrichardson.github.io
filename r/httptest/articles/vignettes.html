<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Write vignettes that are executable anywhere, even by people without API credentials or a network connection, using httptest's tools for recording API requests and then using them as fixtures.">
<title>Writing Vignettes with APIs • httptest</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Writing Vignettes with APIs">
<meta property="og:description" content="Write vignettes that are executable anywhere, even by people without API credentials or a network connection, using httptest's tools for recording API requests and then using them as fixtures.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-104182925-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-104182925-1');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-default navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">httptest</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">4.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/httptest.html">Get Started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/httptest.html">Overview</a>
    <a class="dropdown-item" href="../articles/redacting.html">Redacting Sensitive Information</a>
    <a class="dropdown-item" href="../articles/vignettes.html">Using with Vignettes</a>
    <a class="dropdown-item" href="../articles/faq.html">FAQ</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nealrichardson/httptest">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://enpiar.com">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Writing Vignettes with APIs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nealrichardson/httptest/blob/HEAD/vignettes/vignettes.Rmd" class="external-link"><code>vignettes/vignettes.Rmd</code></a></small>
      <div class="d-none name"><code>vignettes.Rmd</code></div>
    </div>

    
    
<p>Package vignettes (like this!) are a valuable way to show how to use
your code. But if you’re demonstrating a package that communicates with
a remote API, it has been difficult to write useful vignettes.
<code>R CMD check</code> tests that package vignettes, when they are
dynamically generated by Sweave or R Markdown, can successfully be
rebuilt. If your API requires authentication to use, you’d need to
distribute your login credentials for the vignette to build, and that’s
generally not a good idea. Plus, building would require a stable network
connection, without which you might get spurious build failures and CRAN
submission rejections. Workarounds for these challenges, such as writing
static vignettes that only appear to do work, present other problems:
they’re lots of work to maintain and easily become out of sync with the
package.</p>
<p><code>httptest</code> solves these problems. By adding as little as
one line of code to your vignette, you can safely record API responses
from a live session. These API responses are scrubbed of sensitive
personal information and stored in a subfolder in your
<code>vignettes</code> directory. Subsequent vignette builds, including
on continuous-integration services, CRAN, and your package users’
computers, use these recorded responses, allowing the document to
regenerate without a network connection or API credentials. To record
fresh API responses, delete the subfolder of cached responses and
re-run.</p>
<p>This vignette shows you how. To see an example in the wild, see the
<a href="https://enpiar.com/r/pivotaltrackR/articles/pivotaltrackR.html" class="external-link">introduction
vignette to <code>pivotaltrackR</code></a> (<a href="https://github.com/nealrichardson/pivotaltrackR/blob/master/vignettes/pivotaltrackR.Rmd" class="external-link">source</a>).
While this discussion is focused on package vignettes, the same behavior
should work in any R Markdown document.</p>
<div class="section level2">
<h2 id="the-basics-start_vignette">The basics: <code>start_vignette()</code><a class="anchor" aria-label="anchor" href="#the-basics-start_vignette"></a>
</h2>
<p>Getting started is easy. At the beginning of your R Markdown
document, add this code chunk:</p>
<pre><code>`​``{r, include=FALSE}
library(httptest)
start_vignette("vignette-name")
```</code></pre>
<p>changing <code>vignette-name</code> to something meaningful, such as
the name of your <code>.Rmd</code> file. <code><a href="../reference/start_vignette.html">start_vignette()</a></code>
works by checking for the existence of a directory with the name you
provided. If no directory exists, the vignette proceeds making real API
requests and records the responses as fixtures inside the
<code>vignette-name</code> directory (that is, it calls
<code><a href="../reference/capture_requests.html">start_capturing()</a></code>). If the directory does exists,
great—you’ve previously recorded API responses, so it uses them, loading
them with the same <code><a href="../reference/use_mock_api.html">use_mock_api()</a></code> mode you can use in your
test suite.</p>
<blockquote>
<p>Curious about how these recording and mocking contexts work? See
<code>vignettes("httptest")</code> for an overview; it’s focused on
testing rather than vignettes, but the mechanics are the same.</p>
</blockquote>
<p>That’s about it! It is a good idea to add an
<code><a href="../reference/start_vignette.html">end_vignette()</a></code> at the end of the document, like</p>
<pre><code>`​``{r, include=FALSE}
end_vignette()
```</code></pre>
<p>This turns off the request recording or mocking and cleans up the R
session state. It’s not necessary if you build each vignette in a clean
R process and quit on completion (everything is cleaned up when R
exits), but having the <code><a href="../reference/start_vignette.html">end_vignette()</a></code> call is good in case
you build your documents in an interactive session.</p>
<p>Note that these code chunks have <code>include=FALSE</code>. This
prevents them from being printed in the resulting Markdown, HTML, PDF,
or whatever format document you produce. They’re doing work behind the
scenes, so you don’t need them to be shown to your readers.</p>
</div>
<div class="section level2">
<h2 id="handling-server-state-changes">Handling server state changes<a class="anchor" aria-label="anchor" href="#handling-server-state-changes"></a>
</h2>
<p>If all your vignette does is query an API to get data from it,
<code><a href="../reference/start_vignette.html">start_vignette()</a></code> is all you need. Your actions don’t change
the state of anything on the server, so every time you make the same
request (at least within your current session), you get the same
response.</p>
<p>Sometimes, though, the purpose of your code is to alter server state:
you are creating a database entry, sending a tweet, or other similar
action. Suppose you are querying the Twitter API, and you first search
for the <code>#rstats</code> hashtag, then you send a tweet with that
hashtag, and finally you repeat your search. You’d expect the second
search to contain the tweet you just sent.</p>
<p>To make this work, before any code chunk that will alter server
state, call <code><a href="../reference/change_state.html">change_state()</a></code>:</p>
<pre><code>`​``{r, include=FALSE}
change_state()
```</code></pre>
<p>When recording, this adds a new “layer” of recorded responses, and
when reading previously recorded responses, it changes to the next
layer.</p>
<p>For a working example, see the <code>pivotaltrackR</code> vignette.
It does a query, then creates a record on the server, modifies that
record, and then deletes it. All of this is captured in the vignette
data and is fully replayable.</p>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<p>Because you’re recording API responses for replay offline, there are
a few additional considerations. First, you’ll want to make sure not to
expose your personal credentials or other private details in the cached
API responses. <code>httptest</code> provides the ability to “redact”
responses you record, and by default, all standard authentication
methods are redacted from recorded responses. It’s probable that you
don’t need to do anything further to have clean responses, but it’s
worth verifying. Beyond credentials, there may be other attributes of
API responses that you want to modify, such as finding-and-replacing
record ids with a shorter or obfuscated value.,</p>
<p>To modify these responses, you can provide a custom redacting
function. A good way to do this that works for both your test suite and
your vignettes is to put your custom function in
<code>inst/httptest/redact.R</code> in your package, and it will be
automatically used whenever your package is loaded. See more about
redacting in <code><a href="../articles/redacting.html">vignette("redacting")</a></code>.</p>
<p>Second, depending on how long the URLs are in the API requests you
make, you may need to programmatically shorten them if you’re planning
on submitting your package to CRAN because it requires file names to be
100 characters or less. Just as you can provide a custom function to
modify responses that are recorded, you can provide a function to tweak
the request being made in order to map the request to the right file in
the mocked context. Importantly, this lets you truncate the URLs, which
then map to files.</p>
<p>To do this, similarly place a function in
<code>inst/httptest/request.R</code>. Any time your package is loaded
and you’re reading mock (previously recorded) responses, this function
will be called on the <code>request</code> object before mapping it to a
file.</p>
<p>If you don’t want to set these request/response processors globally
for your tests and vignettes, there are a couple of options. Both of
these functions (response redactor and request preprocessor) can be
defined and set in your document’s initial code chunk, using
<code>set_redactor</code> and <code>set_requester</code>, like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://enpiar.com/r/httptest/">httptest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">api_root</span> <span class="op">&lt;-</span> <span class="st">"https://www.pivotaltracker.com/services/v5/"</span></span>
<span><span class="fu"><a href="../reference/set_redactor.html">set_redactor</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">response</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/redact.html">redact_headers</a></span><span class="op">(</span><span class="st">"X-TrackerToken"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/gsub_response.html">gsub_response</a></span><span class="op">(</span><span class="va">api_root</span>, <span class="st">""</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/gsub_response.html">gsub_response</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"pivotal.project"</span><span class="op">)</span>, <span class="st">"123"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/set_requester.html">set_requester</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">request</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">request</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/gsub_response.html">gsub_request</a></span><span class="op">(</span><span class="va">api_root</span>, <span class="st">""</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/gsub_response.html">gsub_request</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"pivotal.project"</span><span class="op">)</span>, <span class="st">"123"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/start_vignette.html">start_vignette</a></span><span class="op">(</span><span class="st">"stories"</span><span class="op">)</span></span></code></pre></div>
<p>This is useful if you’re writing an R Markdown document outside of
the context of a package.</p>
<p>Alternatively, you can put vignette-specific setup and teardown code
for a package in <code>inst/httptest/start-vignette.R</code> and
<code>inst/httptest/end-vignette.R</code>, respectively, and like the
other <code>inst/httptest</code> files, these will be found and used
whenever your package is loaded. This is a good option when you have
more than one vignette and you want to share setup code across them
without copy-and-paste.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Neal Richardson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
