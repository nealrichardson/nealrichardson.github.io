<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> • httpcache</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">httpcache</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/httpcache.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nealrichardson/httpcache">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://enpiar.com">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1></h1>
            
          </div>

    
    
<div class="contents">
<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Improving API client performance with httpcache}
-->
<div id="improving-api-client-performance-with-httpcache" class="section level1">
<h1 class="hasAnchor">
<a href="#improving-api-client-performance-with-httpcache" class="anchor"></a>Improving API client performance with <code>httpcache</code>
</h1>
<p><code>httpcache</code> provides the HTTP verb functions <code><a href="../reference/cached-http-verbs.html">GET()</a></code>, <code>PUT()</code>, <code>PATCH()</code>, <code>POST()</code>, and <code>DELETE()</code>, which are drop-in replacements for those in the <a href="http://httr.r-lib.org">httr</a> package. So, to take advantage of these cache-aware functions, all you need to do is load <code>httpcache</code> instead of <code>httr</code>, or in package development, import from <code>httpcache</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(httpcache)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(a &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cached-http-verbs.html">GET</a></span>(<span class="st">"http://httpbin.org/get"</span>))</code></pre></div>
<pre><code>##    user  system elapsed 
##   0.028   0.002   0.442</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cached-http-verbs.html">GET</a></span>(<span class="st">"http://httpbin.org/get"</span>))</code></pre></div>
<pre><code>##    user  system elapsed 
##       0       0       0</code></pre>
<p>Notice how the second request returns instantly. It’s reading from cache—there’s no communication with a remote server, so no network latency and no server processing time. Remember: the fastest API request is the one you don’t have to make.</p>
<p>Reading from the query cache yields exactly the same response as if we had contacted the server. We can confirm:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">identical</span>(a, b)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div id="query-logging" class="section level2">
<h2 class="hasAnchor">
<a href="#query-logging" class="anchor"></a>Query logging</h2>
<p>How do we know, other than by the faster response, that we’re hitting cache and not making server requests?</p>
<p>When designing API clients in R, logging is an invaluable tool for understanding and improving request patterns. As you build layers of abstraction on top of the direct HTTP requests, it can be easy to make inefficient or repetitive requests that degrade performance for your users and impose unnecessary load on your servers. You can’t improve what you can’t measure, and the logging tools included in <code>httpcache</code> can help you measure.</p>
<p>Let’s clear the cache and repeat that exercise, this time with logging enabled. Use <code><a href="../reference/startLog.html">startLog()</a></code> to enable the request log. <code>startLog</code> takes a file or connection argument, which it passes to <code>cat</code> for log writing. The default, same as for <code>cat</code>, prints to the standard output—your display, in an interactive session. (See <code>?cat</code> for details.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">clearCache</span>()
<span class="kw"><a href="../reference/startLog.html">startLog</a></span>()
a &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cached-http-verbs.html">GET</a></span>(<span class="st">"http://httpbin.org/get"</span>)</code></pre></div>
<pre><code>## 2017-10-14T22:02:47.896 HTTP GET http://httpbin.org/get 200 326 0 0 0 0 0.159 0.159
## 2017-10-14T22:02:47.897 CACHE SET http://httpbin.org/get</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cached-http-verbs.html">GET</a></span>(<span class="st">"http://httpbin.org/get"</span>)</code></pre></div>
<pre><code>## 2017-10-14T22:02:47.898 CACHE HIT http://httpbin.org/get</code></pre>
<p>Notice how the first request results in an “HTTP GET” and a “CACHE SET”, while the second one gets a “CACHE HIT” and does not touch “HTTP”. From this log output, we can conclude that the query cache is working.</p>
<div id="log-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#log-analysis" class="anchor"></a>Log analysis</h3>
<p>You can also pass a file name to <code>startLog</code>. This makes it easier to read the log output back in as a <code>data.frame</code> and analyze it quantitatively. We’ll do an example of that below.</p>
</div>
<div id="custom-logging" class="section level3">
<h3 class="hasAnchor">
<a href="#custom-logging" class="anchor"></a>Custom logging</h3>
<p>You may want to send other events to the log, interspersed with your HTTP requests, whether for their own sake or to see how work done in R outside of the HTTP layer maps onto your server traffic. The function <code><a href="../reference/logMessage.html">logMessage()</a></code> writes to the connection specified by <code>startLog</code>, and it is available for general use. For error logging, the <code><a href="../reference/halt.html">halt()</a></code> function wraps <code>stop</code> and sends a message to the log (it also makes the awkwardly named <code>call.</code> argument to <code>stop</code> default to <code>FALSE</code> for cleaner error messaging).</p>
</div>
</div>
<div id="cache-invalidation" class="section level2">
<h2 class="hasAnchor">
<a href="#cache-invalidation" class="anchor"></a>Cache invalidation</h2>
<p>As the <a href="http://martinfowler.com/bliki/TwoHardThings.html">saying (or joke, depending on the version)</a>, cache invalidation is one of the two hard problems in computer science. The trouble with caching what the server serves is that the server is the source of truth, and if the state of data on the server changes, our local copy of the data is stale. In some applications and with some APIs, we have no idea when the server state changes, but in many cases, the source of change on the server is actions that we initiate ourselves. In these cases, a local query cache is more feasible, and cache invalidation more tractable.</p>
<p><code>httpcache</code> provides some functions to direct cache invalidation. We’ve seen one already, <code>clearCache()</code>, which wipes the entire cache. Other functions give more surgical control. <code><a href="../reference/dropCache.html">dropOnly()</a></code> invalidates cache only for the specified URL. <code><a href="../reference/dropCache.html">dropPattern()</a></code> uses regular expression matching to invalidate cache. <code><a href="../reference/dropCache.html">dropCache()</a></code> is a convenience wrapper around <code>dropPattern</code> that invalidates cache for any resources that start with the given URL.</p>
<p>Depending on the API with which you’re communicating, you may not need to use those cache-invalidation functions directly, or you may need them only infrequently. <code>httpcache</code> was designed with <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a> APIs in mind, particularly those that expose resources that contain collections of entities that can be created, replaced, updated, and deleted with POST, PUT, PATCH, and DELETE, respectively. Consequently, these four HTTP verb functions are built with default cache invalidation actions: <code>POST</code> invalidates cache only for the request URL (<code>dropOnly</code>), for the case where POST creates a new entity appearing as a subresource. For example, if <code>GET http://api.example/projects/</code> returns a catalog of project entities, and POST to <code>http://api.example/projects/</code> creates a resource at <code>http://api.example/projects/new_id/</code>, we need to bust cache for the project catalog on POST, but our cached responses for resources such as <code>http://api.example/projects/old_id/</code> should still be valid. The other three functions, <code>PUT</code>, <code>PATCH</code>, and <code>DELETE</code>, by default drop cache for the request URL and everything “below” it (<code>dropCache</code>). Continuing with the example, if we modify <code>http://api.example/projects/new_id/</code>, we should invalidate cache for that resource and for other resources appearing as subresources of it, such as <code>http://api.example/projects/new_id/users/</code>.</p>
<p>These verb functions (<code>POST</code>, <code>PUT</code>, <code>PATCH</code>, and <code>DELETE</code>) all take a <code>drop</code> argument, which defaults as described above. To override them, you can specify a different call other than <code><a href="../reference/dropCache.html">dropCache(url)</a></code> or <code><a href="../reference/dropCache.html">dropOnly(url)</a></code>, or you can pass <code>drop = NULL</code> and call the cache-invalidation functions directly. Depending on your API and your usage of it, however, <code>httpcache</code>’s cache management may just work for you with no additional effort.</p>
<!-- 
## Example

For a more complete example of the caching, logging, and invalidation features, we'll use a mock HTTP interface from the `httptest` package, which allows demonstration of the features of `httpcache` without requiring a network connection.  We'll make a series of requests, both reads and writes, and we'll capture the action with the logging tools.


```r
library(httptest)
```

```
## Loading required package: testthat
```

do requests. look at log. show cache invalidation. then show reading without internet -->
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#improving-api-client-performance-with-httpcache">Improving API client performance with <code>httpcache</code></a><ul class="nav nav-pills nav-stacked">
<li><a href="#query-logging">Query logging</a></li>
      <li><a href="#cache-invalidation">Cache invalidation</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Neal Richardson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
