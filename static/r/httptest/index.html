<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Test Environment for HTTP Requests • httptest</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="jquery.sticky-kit.min.js"></script><script src="pkgdown.js"></script><link href="extra.css" rel="stylesheet">
<meta property="og:title" content="A Test Environment for HTTP Requests">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google analytics --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104182925-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">enpiar</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">httptest</a>
</li>
<li>
  <a href="articles/httptest.html">Get Started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/httptest.html">Overview</a>
    </li>
    <li>
      <a href="articles/redacting.html">Redacting Sensitive Information</a>
    </li>
    <li>
      <a href="index.html#faq">FAQ</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nealrichardson/httptest">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="/">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="contents col-md-9">
    <div id="httptest-a-test-environment-for-http-requests-in-r" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#httptest-a-test-environment-for-http-requests-in-r" class="anchor"></a>httptest: A Test Environment for HTTP Requests in R</h1></div>

<p>Testing code and packages that communicate with remote servers can be painful. Dealing with authentication, bootstrapping server state, cleaning up objects that may get created during the test run, network flakiness, and other complications can make testing seem too costly to bother with. But it doesn’t need to be that hard. The <code>httptest</code> package enables one to test all of the logic on the R sides of the API in your package without requiring access to the remote service.</p>
<p>Importantly, <code>httptest</code> provides three test <strong>contexts</strong> that mock the network connection in different ways, and it offers additional <strong>expectations</strong> to assert that HTTP requests were–or were not–made. The package also includes a context for recording the responses of real requests and storing them as fixtures that you can later load in a test run. Using these tools, one can test that code is making the intended requests and that it handles the expected responses correctly, all without depending on a connection to a remote API.</p>
<p>This package bridges the gap between two others: (1) <a href="http://testthat.r-lib.org/">testthat</a>, which provides a useful (<a href="https://github.com/r-lib/testthat/blob/master/R/test-that.R#L171">and fun</a>) framework for unit testing in R but doesn’t come with tools for testing across web APIs; and (2) <a href="http://httr.r-lib.org/">httr</a>, which <a href="https://github.com/r-lib/httr/blob/master/R/httr.r#L1">makes working with HTTP in R easy</a> but doesn’t make it simple to test the code that uses it. <code>httptest</code> brings the fun and simplicity together.</p>
<div id="installing" class="section level2">
<h2 class="hasAnchor">
<a href="#installing" class="anchor"></a>Installing</h2>
<p><code>httptest</code> can be installed from CRAN with</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">"httptest"</span>)</code></pre></div>
<p>The pre-release version of the package can be pulled from GitHub using the <a href="https://github.com/hadley/devtools">devtools</a> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install.packages("devtools")</span>
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"nealrichardson/httptest"</span>)</code></pre></div>
</div>
<div id="using" class="section level2">
<h2 class="hasAnchor">
<a href="#using" class="anchor"></a>Using</h2>
<p>Wherever you normally load <code>testthat</code>, load <code>httptest</code> instead. It “requires” <code>testthat</code>, so both will be loaded by using <code>httptest</code>. Specifically, you’ll want to swap in <code>httptest</code> in:</p>
<ul>
<li>the DESCRIPTION file, where <code>testthat</code> is typically referenced under “Suggests”</li>
<li>tests/testthat.R, which may otherwise begin with <code>library(testthat)</code>.</li>
</ul>
<p>Then, you’re ready to start using the tools that <code>httptest</code> provides. The section below outlines the package’s main functions. See the test suite and help pages for usage examples.</p>
<p>When unit-testing code that communicates with another service, you need to make assertions about two different kinds of logic: (1) given some inputs, does my code make the correct request(s) to that service; and (2) does my code correctly handle the types of responses that that service can return? The contexts and expectation functions provided by this package help you to test both sides.</p>
<div id="contexts" class="section level3">
<h3 class="hasAnchor">
<a href="#contexts" class="anchor"></a>Contexts</h3>
<p>The package includes three test contexts, which you wrap around test code that would otherwise make network requests.</p>
<ul>
<li>
<strong><code><a href="reference/without_internet.html">without_internet()</a></code></strong> converts HTTP requests made through <code>httr</code> request functions into errors that print the request method, URL, and body payload, if provided. This is useful for asserting that a function call would make a correctly-formed HTTP request, as well as for asserting that a function does not make a request (because if it did, it would raise an error in this context).</li>
<li>
<strong><code><a href="reference/with_fake_HTTP.html">with_fake_HTTP()</a></code></strong> raises a “message” instead of an “error”, and HTTP requests return a “response”-class object. Like <code>without_internet</code>, it allows you to assert that the correct requests were (or were not) made, but since it doesn’t cause the code to exit with an error, you can test code in functions that comes after requests, provided that it doesn’t expect a particular response to each request.</li>
<li>
<strong><code><a href="reference/with_mock_API.html">with_mock_API()</a></code></strong> lets you provide custom fixtures as responses to requests. It maps URLs, including query parameters, to files in your test directory, and it includes the file contents in the mocked “response” object. Request methods that do not have a corresponding fixture file raise errors the same way that <code>without_internet</code> does. This context allows you to test more complex R code that makes requests and does something with the response, simulating how the API should respond to specific requests.</li>
</ul>
</div>
<div id="expectations" class="section level3">
<h3 class="hasAnchor">
<a href="#expectations" class="anchor"></a>Expectations</h3>
<ul>
<li>
<strong><code><a href="reference/expect-verb.html">expect_GET()</a></code></strong>, <strong><code>expect_PUT()</code></strong>, <strong><code>expect_PATCH()</code></strong>, <strong><code>expect_POST()</code></strong>, and <strong><code>expect_DELETE()</code></strong> assert that the specified HTTP request is made within one of the test contexts. They catch the error or message raised by the mocked HTTP service and check that the request URL and optional body match the expectation. (Mocked responses in <code>with_mock_API</code> just proceed with their response content and don’t trigger <code>expect_GET</code>, however.)</li>
<li>
<strong><code>expect_no_request()</code></strong> is the inverse of those: it asserts that no error or message from a mocked HTTP service is raised.</li>
<li>
<strong><code><a href="reference/expect_header.html">expect_header()</a></code></strong> asserts that an HTTP request, mocked or not, contains a request header.</li>
<li>
<strong><code><a href="reference/expect_json_equivalent.html">expect_json_equivalent()</a></code></strong> doesn’t directly concern HTTP, but it is useful for working with JSON APIs. It checks that two R objects would generate equivalent JSON, taking into account how JSON objects are unordered whereas R named lists are ordered.</li>
</ul>
</div>
<div id="recording-requests" class="section level3">
<h3 class="hasAnchor">
<a href="#recording-requests" class="anchor"></a>Recording requests</h3>
<p>A fourth context, <strong><code><a href="reference/capture_requests.html">capture_requests()</a></code></strong>, collects the responses from requests you make and stores them as mock files. This enables you to perform a series of requests against a live server once and then build your test suite using those mocks, running your tests in <code>with_mock_API</code>.</p>
<p>Mocks stored by <code>capture_requests</code> are written out as plain-text files, either with extension <code>.json</code> if the request returned JSON content or with extension <code>.R</code> otherwise. The <code>.R</code> files contain syntax that when executed recreates the <code>httr</code> “response” object. By storing fixtures as plain-text files, you can more easily confirm that your mocks look correct, and you can more easily maintain them without having to re-record them. If the API changes subtly, such as when adding an additional attribute to an object, you can just touch up the mocks.</p>
</div>
<div id="other-tools" class="section level3">
<h3 class="hasAnchor">
<a href="#other-tools" class="anchor"></a>Other tools</h3>
<ul>
<li>
<strong><code><a href="reference/skip_if_disconnected.html">skip_if_disconnected()</a></code></strong> skips following tests if you don’t have a working internet connection or can’t reach a given URL. This is useful for preventing spurious failures when doing integration tests with a real API.</li>
<li>
<strong><code><a href="reference/public.html">public()</a></code></strong> is another wrapper around test code that will cause tests to fail if they call functions that aren’t “exported” in the package’s namespace. Nothing HTTP specific about it, but it’s something that I’ve found useful for preventing accidentally releasing a package without documenting and exporting new functions. While you can use “examples” in the man pages for ensuring that functions you’re documenting are exported, code that communicates with remote APIs may not be easily set up to run in a help page example. This context allows you to make those assertions within your test suite.</li>
</ul>
</div>
<div id="faq" class="section level3">
<h3 class="hasAnchor">
<a href="#faq" class="anchor"></a>FAQ</h3>
<div id="where-are-my-mocks-recorded" class="section level4">
<h4 class="hasAnchor">
<a href="#where-are-my-mocks-recorded" class="anchor"></a>Where are my mocks recorded?</h4>
<p><strong>Q.</strong> I’m using <code><a href="reference/capture_requests.html">capture_requests()</a></code> but when I try to run tests with those fixtures in <code><a href="reference/with_mock_API.html">with_mock_API()</a></code>, the tests are erroring and printing the request URLs. Why aren’t the tests finding the mocks?</p>
<p><strong>A.</strong> First, make sure that your recorded request files are where you think they are and where your tests think they should be. When recording fixtures, keep in mind that the destination path for <code>capture_requests</code> is relative to the current working directory of the process. If you’re running <code>capture_requests</code> within a test suite in an installed package, the working directory may not be the same as your code repository. So either record the requests in an interactive session, or you may have to specify an absolute path if you want to record when running package tests.</p>
<p>If you don’t see the captured request files, try specifying <code>verbose = TRUE</code> when calling <code>capture_requests</code> or <code>start_capturing</code>, and it will message the absolute path of the files as it writes them.</p>
<p>Second, once you see where your mock files are, make sure that you’ve placed the mock directories at the same level of directory nesting as your <code>test-*.R</code> files, or if you want them somewhere else, that you’ve set <code>.mockPaths</code> appropriately.</p>
</div>
<div id="how-do-i-fix-non-portable-file-paths" class="section level4">
<h4 class="hasAnchor">
<a href="#how-do-i-fix-non-portable-file-paths" class="anchor"></a>How do I fix “non-portable file paths”?</h4>
<p><strong>Q.</strong> I have tests working nicely with <code><a href="reference/with_mock_API.html">with_mock_API()</a></code> but <code>R CMD build</code> and <code>R CMD check</code> warn that my package has “non-portable file paths”. How do I make legal file paths that my code and tests will recognize?</p>
<p><strong>A.</strong> Generally, this error means that there are file paths are longer than 100 characters. Depending on how long your URLs are, there are a few ways to save on characters without compromising readability of your code and tests. First, if you have your tests inside a <code>tests/testthat/</code> directory, and your fixture files inside that, you can save 9 characters by moving the fixtures up to <code>tests/</code> and setting <code><a href="reference/mockPaths.html">.mockPaths("../")</a></code>.</p>
<p>If you need to save more, look for places where your URLs contain segments that perhaps could be (or already are) configurable settings. For example, if all of your API endpoints sit beneath <code>https://language.googleapis.com/v1/</code>, you could define that in your package as <code>options(mypackage.api="https://language.googleapis.com/v1/")</code>, construct your URLs relative to that in the code, and then in your tests, set something different, such as <code>options(mypackage.api="api/")</code>. That way, all mocked requests would have a path starting with “api/” rather than “language.googleapis.com/v1/”, saving you (in this case) another 23 characters.</p>
<p>You may also be able to economize on other parts of the file paths. If you’ve recorded requests and your file paths contain long entity ids like “1495480537a3c1bf58486b7e544ce83d”, depending on how you access the API in your code, you may be able to simply replace that id with something shorter, like “1”. The mocks are just files, disconnected from a real server and API, so you can rename them and munge them as needed.</p>
</div>
<div id="how-do-i-switch-between-mocking-and-real-requests" class="section level4">
<h4 class="hasAnchor">
<a href="#how-do-i-switch-between-mocking-and-real-requests" class="anchor"></a>How do I switch between mocking and real requests?</h4>
<p><strong>Q.</strong> I’d like to run my mocked tests sometimes against the real API, perhaps to turn them into integration tests, or perhaps to use the same test code to record the mocks that I’ll later use. How can I do this without copying the contents of the tests inside the <code><a href="reference/with_mock_API.html">with_mock_API()</a></code> blocks?</p>
<p><strong>A.</strong> One way to do this is to set <code><a href="reference/with_mock_API.html">with_mock_API()</a></code> to another function in your test file (or in <code>helper.R</code> if you want it to run for all test files). So</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="reference/with_mock_API.html">with_mock_API</a></span>({
    a &lt;-<span class="st"> </span><span class="kw">GET</span>(<span class="st">"https://httpbin.org/get"</span>)
    <span class="kw">print</span>(a)
})</code></pre></div>
<p>looks for the mock file, but</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">with_mock_API &lt;-<span class="st"> </span>force
<span class="kw"><a href="reference/with_mock_API.html">with_mock_API</a></span>({
    a &lt;-<span class="st"> </span><span class="kw">GET</span>(<span class="st">"https://httpbin.org/get"</span>)
    <span class="kw">print</span>(a)
})</code></pre></div>
<p>just evaluates the code with no mocking and makes the request, and</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">with_mock_API &lt;-<span class="st"> </span>capture_requests
<span class="kw"><a href="reference/with_mock_API.html">with_mock_API</a></span>({
    a &lt;-<span class="st"> </span><span class="kw">GET</span>(<span class="st">"https://httpbin.org/get"</span>)
    <span class="kw">print</span>(a)
})</code></pre></div>
<p>would make the request and record the response as a mock file. You could control this behavior with environment variables by adding something like</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="kw">Sys.getenv</span>(<span class="st">"MOCK_BYPASS"</span>) <span class="op">==</span><span class="st"> "true"</span>) {
    with_mock_api &lt;-<span class="st"> </span>force
} <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">Sys.getenv</span>(<span class="st">"MOCK_BYPASS"</span>) <span class="op">==</span><span class="st"> "capture"</span>) {
    with_mock_api &lt;-<span class="st"> </span>capture_requests
}</code></pre></div>
<p>to your <code>helper.R</code>.</p>
</div>
</div>
</div>
<div id="contributing" class="section level2">
<h2 class="hasAnchor">
<a href="#contributing" class="anchor"></a>Contributing</h2>
<p>Suggestions and pull requests are more than welcome. This package was initially pulled together from test setup code I’d written and copied around among three different packages. While the code here has been well used and hashed out over a couple of years of working with them, I have naturally focused on features that have been helpful for working with specific APIs. The concepts provided here are generally useful, but some details or conveniences for working with other APIs may be missing. In particular, the package privileges <code>"Content-Type: application/json"</code> in several places.</p>
</div>
<div id="for-developers" class="section level2">
<h2 class="hasAnchor">
<a href="#for-developers" class="anchor"></a>For developers</h2>
<p>The repository includes a Makefile to facilitate some common tasks.</p>
<div id="running-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#running-tests" class="anchor"></a>Running tests</h3>
<p><code>$ make test</code>. You can also specify a specific test file or files to run by adding a “file=” argument, like <code>$ make test file=offline</code>. <code>test_package</code> will do a regular-expression pattern match within the file names. See its documentation in the <code>testthat</code> package.</p>
</div>
<div id="updating-documentation" class="section level3">
<h3 class="hasAnchor">
<a href="#updating-documentation" class="anchor"></a>Updating documentation</h3>
<p><code>$ make doc</code>. Requires the <a href="https://github.com/klutometis/roxygen">roxygen2</a> package.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3" id="sidebar">
    <h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cran.r-project.org/package=httptest">https://​cran.r-project.org/​package=httptest</a>
</li>
<li>Browse source code at <br><a href="https://github.com/nealrichardson/httptest">https://​github.com/​nealrichardson/​httptest</a>
</li>
<li>Report a bug at <br><a href="https://github.com/nealrichardson/httptest/issues">https://​github.com/​nealrichardson/​httptest/​issues</a>
</li>
</ul>
<h2>License</h2>
<p><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE.html">LICENSE</a></p>
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Neal Richardson <br><small class="roles"> Author, maintainer </small> </li>
</ul>
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://travis-ci.org/nealrichardson/httptest"><img src="https://travis-ci.org/nealrichardson/httptest.png?branch=master" alt="Build Status"></a></li>
<li><a href="https://ci.appveyor.com/project/nealrichardson/httptest"><img src="https://ci.appveyor.com/api/projects/status/egrw65593iso21cu?svg=true" alt="Build status"></a></li>
<li><a href="https://codecov.io/gh/nealrichardson/httptest"><img src="https://codecov.io/gh/nealrichardson/httptest/branch/master/graph/badge.svg" alt="codecov"></a></li>
<li><a href="https://cran.r-project.org/package=httptest"><img src="https://www.r-pkg.org/badges/version-last-release/httptest" alt="cran"></a></li>
</ul>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Neal Richardson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
