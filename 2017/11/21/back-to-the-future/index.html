<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta name="generator" content="Hugo 0.20.7" />
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Back to the Future </title>

  
  <meta name="description" content="Maintaining R packages on CRAN sometimes means you have to find creative ways to ensure that your code runs on different platforms and on multiple versions of R---even ones that haven&#39;t been released yet."> 
  
  
  
  
  

    

  <meta name="author" content="">


  <meta property="og:title" content="Back to the Future" />
<meta property="og:description" content="Maintaining R packages on CRAN sometimes means you have to find creative ways to ensure that your code runs on different platforms and on multiple versions of R---even ones that haven&#39;t been released yet." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2017/11/21/back-to-the-future/" />



<meta property="article:published_time" content="2017-11-21T16:49:57-07:00"/>
<meta property="article:modified_time" content="2017-11-21T16:49:57-07:00"/>











  




  
  
  
  
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-104182925-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

  

  <link rel="canonical" href="/2017/11/21/back-to-the-future/">  

  <link rel="shortcut icon" type="image/png" href="/favicon.ico">


  <link href="/css/font.css" rel="stylesheet" type="text/css">
  <link href="/css/kube.min.css" rel="stylesheet" type="text/css">
  <link href="/css/kube.legenda.css" rel="stylesheet" type="text/css">
  <link href="/css/highlight.css" rel="stylesheet" type="text/css">
  <link href="/css/master.css" rel="stylesheet" type="text/css">
  <link href="/css/kube.demo.css" rel="stylesheet" type="text/css">

 <link href="/css/custom.css" rel="stylesheet" type="text/css">

  <script src="/js/jquery-2.1.4.min.js" type="text/javascript">
  </script>

  <script type="text/javascript" src="/js/tocbot.min.js"></script>
</head>


<body class="page-kube">
  <header> 


<link href='//cdn.bootcss.com/highlight.js/9.10.0/styles/color-brewer.min.css' rel='stylesheet' type='text/css'>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<div class="show-sm">
    <div id="nav-toggle-box">
      <div id="nav-toggle-brand">
        <a href="/">All posts</a>
      </div><a data-component="toggleme" data-target="#top" href="#" id="nav-toggle"><i class="kube-menu"></i></a>
    </div>
  </div>
  <div class="hide-sm" id="top">
    <div id="top-brand">
        enpiar
    </div>
    <nav id="top-nav-main">
      <ul>
          
          
              <li><a href="/about/" >About</a></li>
          
              <li><a href="/" >Blog</a></li>
          
              <li><a href="/r/" >Code</a></li>
          
      </ul>
    </nav>
    <nav id="top-nav-extra">
      <ul>
          
              <li><a href="https://github.com/nealrichardson"><span class="fa fa-github fa-lg"></span></a></li>
          
              <li><a href="https://twitter.com/enpiar"><span class="fa fa-twitter fa-lg"></span></a></li>
          
      </ul>
    </nav>
  </div>
 </header>
  <main>
<div class="push-center" itemscope itemtype="http://schema.org/BlogPosting">
    
<meta itemprop="name" content="Back to the Future">
<meta itemprop="description" content="Maintaining R packages on CRAN sometimes means you have to find creative ways to ensure that your code runs on different platforms and on multiple versions of R---even ones that haven&#39;t been released yet.">


<meta itemprop="dateModified" content="2017-11-21T16:49:57-07:00" />
<meta itemprop="wordCount" content="749">



<meta itemprop="keywords" content="code,general,management,automation,cran,dependencies,httptest,meta,packages,python,r,tdd,testing,travis-ci,website," />

<div id="hero">
    <h1 itemprop="headline">  Back to the Future</h1>
    
<blockquote itemprop="description">Maintaining R packages on CRAN sometimes means you have to find creative ways to ensure that your code runs on different platforms and on multiple versions of R---even ones that haven't been released yet.</blockquote>

<time class="post-time">
   <span datetime="2017-11-21T16:49:57-07:00">21 Nov 2017</span>

</time>
</div>
<div id="post-box">
<div id="post" itemprop="articleBody">

    <p>When you submit a package update to CRAN, they ask you to check some boxes confirming that you&rsquo;ve done your due diligence on your submission: that it passes its checks. One confirmation is that you&rsquo;ve addressed any failures on the CRAN package check page, which looks <a href="https://cran.r-project.org/web/checks/check_results_httptest.html">like this</a>.</p>

<p><iframe src="https://cran.r-project.org/web/checks/check_results_httptest.html" width=600 height=600/></p>

<p>This page is a window into one of the key features of CRAN: it runs continuous-integration tests of your package against multiple versions of R, on multiple operating systems, with the current version of your dependencies. You can&rsquo;t (without a special dispensation) submit a package to CRAN that doesn&rsquo;t work on all platforms that R supports, and you always have to pass against the bleeding edge development version.</p>

<p>A benefit of this system is that, as a user, you can trust that a new R release isn&rsquo;t going to break your packages, and if a package update makes it to CRAN, it has at least not broken other packages in the CRAN ecosystem. The cost of supporting the system gets passed along to R developers, both core and package maintainers, who have to maintain backwards compatibility&mdash;and forwards compatibility to future R releases.</p>

<p>While no one likes to have a package release held up by some funky compatibility issue, I&rsquo;ve found that I&rsquo;ve oddly enjoyed solving these problems when they arise. It&rsquo;s a logic puzzle: how do I most efficiently get my code (package tests) to pass in different worlds that have different functions, options, and rules? Although it is frustrating in the moment having to spend time and energy on it, there&rsquo;s satisfaction in the clever solution: it feels good to solve the CRAN-sphinx&rsquo;s riddle.</p>

<p>Here&rsquo;s four examples.</p>

<ol>
<li>UTF-8 nuisance</li>
</ol>

<p>Like the movies, the one going back farthest in time was the least enjoyable. I had a CRAN submission rejected because the tests failed to run on Solaris, which R still supports and CRAN includes in their continuous integration checks. The problem was an encoding issue: specifically, I had non-ASCII UTF-8 in a test file, and the test file <em>failed to parse</em>. That&rsquo;s right: the tests didn&rsquo;t run and fail, the file couldn&rsquo;t be read at all. Naturally, <code>R CMD check</code> passed locally for me, and it passed on Travis and Appveyor.</p>

<p>Suppose the offending test file contained this.</p>

<pre><code class="language-r">test_that(&quot;Something about UTF-8&quot;, {
    expect_identical(Encoding(&quot;Budějovický Budvar&quot;), &quot;UTF-8&quot;)
})
</code></pre>

<p>Adding <code>skip_on_cran()</code> like this</p>

<pre><code class="language-r">test_that(&quot;Something about UTF-8&quot;, {
    skip_on_cran()
    expect_identical(Encoding(&quot;Budějovický Budvar&quot;), &quot;UTF-8&quot;)
})
</code></pre>

<p>doesn&rsquo;t fix the issue because it&rsquo;s the file itself that can&rsquo;t parse: it wasn&rsquo;t even getting to the point of executing the test code.</p>

<p>To work around the issue, I moved the <code>test_that</code> code block that contained UTF-8 to another file, &ldquo;utftesting.R&rdquo;, and then <code>source()</code>d that file:</p>

<pre><code class="language-r">test_that(&quot;Something about UTF-8&quot;, {
    skip_on_cran()
    source(&quot;utftesting.R&quot;, local=TRUE)
})
</code></pre>

<p>That way, the tests can still exist and be run locally and on Travis, but they&rsquo;re appropriately skipped on CRAN. This works because <code>testthat</code> only runs the <code>test-*.R</code> files, not any other .R or other kinds of files you have in your test directory. &ldquo;utftesting.R&rdquo; only gets touched after <code>skip_on_cran()</code> is called.</p>

<p>To prevent a future relapse, I added this check that my test- files are all ASCII:</p>

<pre><code class="language-r">test_that(&quot;All test- files are ASCII (for CHECK)&quot;, {
    testfiles &lt;- dir(pattern=&quot;^test.*R$&quot;)
    for (i in testfiles) {
        expect_warning(scan(i, what=character(), fileEncoding=&quot;ascii&quot;, quiet=TRUE),
            NA, info=i)
    }
})
</code></pre>

<ol>
<li>startsWith</li>
</ol>

<pre><code class="language-r">## from future import ...
basefuns &lt;- ls(envir=asNamespace(&quot;base&quot;))
alt.startsWith &lt;- function (x, prefix) {
    substr(x, 1, nchar(prefix)) == prefix
}
if (!(&quot;startsWith&quot; %in% basefuns)) {
    startsWith &lt;- alt.startsWith
}

alt.endsWith &lt;- function (x, suffix) {
    z &lt;- nchar(x)
    substr(x, z - nchar(suffix) + 1, z) == suffix
}
if (!(&quot;endsWith&quot; %in% basefuns)) {
    endsWith &lt;- alt.endsWith
}
</code></pre>

<ol>
<li>median signature</li>
</ol>

<pre><code class="language-r">## Future-proofing for change to median signature in R &gt;= 3.4
is.R.3.4 &lt;- &quot;...&quot; %in% names(formals(median))

median_func &lt;- function (v) {
    if (v) return(function (x, na.rm=FALSE, ...) .summary.stat(x, &quot;median&quot;, na.rm=na.rm))
    return(function (x, na.rm=FALSE) .summary.stat(x, &quot;median&quot;, na.rm=na.rm))
}

setMethod(&quot;median&quot;, &quot;NumericVariable&quot;, median_func(is.R.3.4))
</code></pre>

<ol>
<li>deparse</li>
</ol>

<p><code>deparse(x, control=deparseNamedList())</code></p>

<pre><code class="language-r">deparseNamedList &lt;- function () {
    ## r73699 2017-11-09
    ## (https://github.com/wch/r-source/commit/62fced00949b9a261034d24789175b205f7fa866)
    ## adds a &quot;niceNames&quot; deparse option, which is now required to get named
    ## lists printed with names (they no longer are named with `control=NULL`).
    ## As it turns out, you can't specify &quot;niceNames&quot; prophalactically---it
    ## errors on older versions of R that don't support it. So this function
    ## standardizes the behavior across R versions.
    ##
    ## R 3.4.2 has the old behavior. The new behavior may appear in R 3.4.3, or
    ## perhaps not until R 3.5.
    past &lt;- inherits(try(.deparseOpts(&quot;niceNames&quot;), silent=TRUE), &quot;try-error&quot;)
    past &lt;- ifelse(past, &quot;old&quot;, &quot;new&quot;)
    return(list(new=&quot;niceNames&quot;)[[past]])
}
</code></pre>


</div>
    <div class="">
        <p>
  Published
  <time datetime="2017-11-21T16:49:57-07:00">
    21 Nov 2017
  </time>
  
    in <span itemprop="articleSection"><a href="/categories/code/">code</a></span>
  
  
    and tagged <a href="/tags/cran/">CRAN</a>, <a href="/tags/r/">R</a> and <a href="/tags/packages/">packages</a>
  
</p>

        
  



  <aside>
    <heade><strong>Related Content</strong></header>
    <hr>
    <ul>
      
      
        <li><a href="/2017/11/21/getting-down-with-pkgdown/">Getting Down with pkgdown</a> &ndash; 13 minutes
      
        <li><a href="/2017/10/20/httptest-2.3.2-released/">httptest 2.3.2 Released</a> &ndash; 3 minutes
      
        <li><a href="/2017/08/11/one-hour-package/">One-Hour Package</a> &ndash; 14 minutes
      
        <li><a href="/2017/08/05/should-you-add-a-package-dependency/">Should You Add a Package Dependency?</a> &ndash; 10 minutes
      
        <li><a href="/2017/06/21/7-hard-testing-problems-made-easy-by-httptest/">7 Hard Testing Problems Made Easy By httptest</a> &ndash; 11 minutes
      
        <li><a href="/2017/06/01/building-a-blogdown-site-with-travis-ci/">Building a Blogdown Site with Travis-CI</a> &ndash; 9 minutes
      
    </ul>
  </aside>


    </div>

    

</div>
</div>
</main>
  <footer>   <footer id="footer">
    <nav>
      <ul>
        <li><span>enpiar</span></li>
        <li>
          <a href="/">Blog</a>
        </li>
      <li>
        <a href="https://github.com/nealrichardson/">GitHub</a>
      </li>
        <li>
          <a href="http://twitter.com/enpiar">Twitter</a>
        </li>
      </ul>
    </nav>
    
  </footer>
  



<script src="//cdn.bootcss.com/highlight.js/9.10.0/highlight.min.js"></script>

<script src="//cdn.bootcss.com/highlight.js/9.10.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.10.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



 </footer>


  <script src="/js/kube.js" type="text/javascript">
  </script>
  <script src="/js/kube.legenda.js" type="text/javascript">
  </script>
  <script src="/js/master.js" type="text/javascript">
  </script>
</body>

</html>
